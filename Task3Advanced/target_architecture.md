# Целевая архитектура системы "Будущее 2.0" (горизонт 3 года)

## C4-модель: Уровень контейнеров

### Контекст системы
Система "Будущее 2.0" представляет собой событийную платформу для медицинских, финансовых и аналитических сервисов с доменной организацией и возможностью масштабирования по продуктам, географии и источникам данных.

### Контейнеры целевой архитектуры

#### 1. Домены бизнес-логики

**1.1. Медицинский домен**
- **Контейнер: Медицинские сервисы (Microservices)**
  - Компоненты:
    - Управление пациентами
    - Управление клиниками
    - Управление персоналом
    - Управление инвентаризацией
  - Технологии: Java/Spring Boot, PostgreSQL
  - Взаимодействие: Публикует события через Event Bus

- **Контейнер: ИИ-сервисы для медицины**
  - Компоненты:
    - Обработка медицинских данных
    - Генерация рекомендаций
    - Анализ диагностических данных
  - Технологии: Python/FastAPI, ML-модели
  - Взаимодействие: Подписывается на события медицинского домена

**1.2. Финансовый домен**
- **Контейнер: Финтех-сервисы**
  - Компоненты:
    - Управление счетами
    - Кредитные операции
    - Платежи и транзакции
    - Финансовая отчётность
  - Технологии: Golang, Java, PostgreSQL
  - Взаимодействие: Публикует события через Event Bus

**1.3. Аналитический домен**
- **Контейнер: Витрина данных (Data Mart)**
  - Компоненты:
    - Порталы самообслуживания
    - Конструктор отчётов
    - Управление доступом
    - Кэширование запросов
  - Технологии: React/Vue.js, Node.js, Redis
  - Взаимодействие: Читает из потоковых витрин и Data Lake

- **Контейнер: Потоковые витрины (Streaming Data Marts)**
  - Компоненты:
    - Агрегация данных в реальном времени
    - Предрасчёт метрик
    - Обновление кэшей
  - Технологии: Apache Flink, Kafka Streams
  - Взаимодействие: Подписывается на Event Bus, записывает в Data Lake

**1.4. Интеграционный домен**
- **Контейнер: Event Bus (Событийная шина)**
  - Компоненты:
    - Брокер сообщений
    - Schema Registry
    - Dead Letter Queue (DLQ)
    - Мониторинг событий
  - Технологии: Apache Kafka, Schema Registry
  - Взаимодействие: Центральная точка интеграции всех доменов

- **Контейнер: Антикоррупционный слой (Anti-Corruption Layer)**
  - Компоненты:
    - Адаптеры для легаси-систем
    - Трансформация данных
    - Синхронизация с DWH
    - Синхронизация с Camel
  - Технологии: Java/Spring Integration, Apache Camel
  - Взаимодействие: Мост между событийной архитектурой и легаси

#### 2. Платформа данных

**2.1. Хранилище данных**
- **Контейнер: Data Lake**
  - Компоненты:
    - Хранилище сырых данных
    - Хранилище обработанных данных
    - Метаданные и каталог
    - Управление версиями данных
  - Технологии: Apache Iceberg/Delta Lake, S3-совместимое хранилище
  - Взаимодействие: Принимает данные из Event Bus и потоковых витрин

- **Контейнер: Операционные БД доменов**
  - Компоненты:
    - PostgreSQL для медицинского домена
    - PostgreSQL для финансового домена
    - Специализированные БД для ИИ-сервисов
  - Технологии: PostgreSQL, TimescaleDB (для временных рядов)
  - Взаимодействие: Источники событий для Event Bus

**2.2. Обработка данных**
- **Контейнер: Потоковая обработка (Stream Processing)**
  - Компоненты:
    - Обработка событий в реальном времени
    - Агрегация метрик
    - Обогащение данных
    - Обработка DLQ
  - Технологии: Apache Flink, Kafka Streams
  - Взаимодействие: Читает из Event Bus, записывает в Data Lake и потоковые витрины

- **Контейнер: Пакетная обработка (Batch Processing)**
  - Компоненты:
    - ETL-процессы
    - Историческая загрузка
    - Репликация данных
  - Технологии: Apache Spark, Airflow
  - Взаимодействие: Читает из Data Lake, записывает в витрины

#### 3. Интеграция с внешними системами

**3.1. Внешние интеграции**
- **Контейнер: API Gateway**
  - Компоненты:
    - Маршрутизация запросов
    - Аутентификация и авторизация
    - Rate limiting
    - Мониторинг API
  - Технологии: Kong, AWS API Gateway
  - Взаимодействие: Точка входа для внешних клиентов

- **Контейнер: Интеграции с партнёрами**
  - Компоненты:
    - Адаптеры для фармацевтических компаний
    - Адаптеры для производителей оборудования
    - Синхронизация данных
  - Технологии: REST API, GraphQL, Webhooks
  - Взаимодействие: Через API Gateway и Event Bus

#### 4. Инфраструктурные сервисы

**4.1. Безопасность и соответствие**
- **Контейнер: Identity & Access Management (IAM)**
  - Компоненты:
    - Аутентификация
    - Авторизация
    - Управление ролями
    - Аудит доступа
  - Технологии: Keycloak, OAuth2/OIDC
  - Взаимодействие: Используется всеми контейнерами

- **Контейнер: Compliance & Audit**
  - Компоненты:
    - Логирование действий
    - Аудит доступа к данным
    - Соответствие регуляторным требованиям
    - Шифрование данных
  - Технологии: ELK Stack, Vault
  - Взаимодействие: Интегрирован со всеми контейнерами

**4.2. Мониторинг и наблюдаемость**
- **Контейнер: Observability Platform**
  - Компоненты:
    - Сбор метрик
    - Централизованное логирование
    - Трейсинг распределённых систем
    - Алертинг
  - Технологии: Prometheus, Grafana, Jaeger, ELK Stack
  - Взаимодействие: Собирает данные со всех контейнеров

**4.3. Управление инфраструктурой**
- **Контейнер: Container Orchestration**
  - Компоненты:
    - Оркестрация контейнеров
    - Автомасштабирование
    - Service Discovery
    - Load Balancing
  - Технологии: Kubernetes
  - Взаимодействие: Хостит все контейнеры

## C4-модель: Уровень компонентов (на примере ключевых контейнеров)

### Контейнер: Витрина данных

**Компоненты:**
1. **Frontend Portal**
   - React/Vue.js приложение
   - Конструктор отчётов
   - Визуализация данных
   - Управление дашбордами

2. **API Gateway (внутренний)**
   - REST API для фронтенда
   - GraphQL API для гибких запросов
   - Кэширование ответов

3. **Query Service**
   - Выполнение аналитических запросов
   - Оптимизация запросов
   - Управление соединениями с БД

4. **Report Builder**
   - Конструктор SQL-запросов
   - Валидация запросов
   - Сохранение шаблонов отчётов

5. **Access Control**
   - Проверка прав доступа
   - Фильтрация данных по ролям
   - Аудит запросов

6. **Cache Manager**
   - Кэширование результатов запросов
   - Инвалидация кэша
   - Управление TTL

### Контейнер: Event Bus

**Компоненты:**
1. **Message Broker**
   - Kafka кластер
   - Управление топиками
   - Репликация сообщений

2. **Schema Registry**
   - Хранение схем событий
   - Валидация схем
   - Версионирование схем

3. **DLQ Handler**
   - Обработка неуспешных сообщений
   - Retry механизм
   - Уведомления об ошибках

4. **Event Router**
   - Маршрутизация событий
   - Фильтрация событий
   - Трансформация событий

5. **Monitoring Agent**
   - Сбор метрик Kafka
   - Мониторинг лаг-ов
   - Алертинг

### Контейнер: Потоковые витрины

**Компоненты:**
1. **Stream Processor**
   - Обработка потоков событий
   - Агрегация данных
   - Окна времени (time windows)

2. **State Store**
   - Хранение состояния агрегаций
   - Snapshot механизм
   - Восстановление состояния

3. **Materialized View Manager**
   - Управление материализованными представлениями
   - Обновление представлений
   - Оптимизация запросов

4. **Data Sink**
   - Запись в Data Lake
   - Запись в кэш
   - Уведомления об обновлениях

## Ключевые изменения при масштабировании

### Новые бизнес-направления
- **Фармацевтические компании**: Новый домен с собственными сервисами, интеграция через Event Bus
- **Производитель оборудования**: IoT-интеграции, потоковая обработка телеметрии
- **Географическое расширение**: Региональные инстансы с синхронизацией через Event Bus

### Новые источники данных
- IoT-датчики медицинского оборудования
- Внешние API партнёров
- Социальные сети и отзывы
- Данные о погоде и экологии (для медицинской аналитики)

### Отказ от легаси-систем
- **DWH SQL Server 2008**: Заменён на Data Lake и доменные БД
- **Power Builder**: Заменён на веб-портал витрины данных
- **Apache Camel шина**: Используется только как антикоррупционный слой, постепенно выводится
- **Power BI**: Интегрирован с новой архитектурой через API, постепенно заменяется на встроенные визуализации

## Принципы архитектуры

1. **Событийная архитектура**: Все домены взаимодействуют через события
2. **Доменная изоляция**: Каждый домен имеет независимую БД и сервисы
3. **Масштабируемость**: Горизонтальное масштабирование всех компонентов
4. **Безопасность**: Единая система IAM, шифрование данных, аудит
5. **Наблюдаемость**: Централизованный мониторинг и логирование
6. **Геораспределённость**: Поддержка мультирегионального развёртывания
